<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Persistent Shared Pixel Canvas</title>
<style>
  body { 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    font-family: sans-serif; 
    margin: 0; 
    padding: 20px; 
    background: #eee; 
  }
  canvas { 
    border: 1px solid #000; 
    image-rendering: pixelated; 
    cursor: crosshair; 
  }
  #controls { margin-bottom: 10px; }
  #info, #countdown { font-weight: bold; margin-top: 10px; }
</style>
<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// --- Supabase config ---
const SUPABASE_URL = "https://pemfxpowmsajsxsveoli.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlbGZ4cG93bXNhanN4c3Zlb2xpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NjYyNzMsImV4cCI6MjA3MTM0MjI3M30.SJBgs4kQTqyn6S6A3usxTHaWK-nb2R51DMznT6geA_M";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// --- Grid config ---
const gridWidth = 100;
const gridHeight = 60;
const pixelSize = 10;

// --- Canvas setup ---
const canvas = document.getElementById("canvas");
canvas.width = gridWidth * pixelSize;
canvas.height = gridHeight * pixelSize;
const ctx = canvas.getContext("2d");

// --- UI elements ---
const colorInput = document.getElementById("color");
const info = document.getElementById("info");
const countdownEl = document.createElement("div");
countdownEl.id = "countdown";
document.body.insertBefore(countdownEl, canvas);

// --- Pixel state ---
const pixels = new Map(); // key = x_y, value = color
let remaining = 10;

// --- Helpers ---
function key(x,y){ return `${x}_${y}`; }
function drawPixel(x,y,color){ ctx.fillStyle = color; ctx.fillRect(x*pixelSize,y*pixelSize,pixelSize,pixelSize); }
function updateInfo(){ info.innerText = `Pixels left: ${remaining}`; }
function clearCanvas(){ ctx.clearRect(0,0,canvas.width,canvas.height); pixels.clear(); }

// --- Load existing pixels ---
async function loadPixels(){
  clearCanvas();
  const { data } = await supabase.from("pixels").select("*");
  if(data) data.forEach(p => {
    pixels.set(key(p.x,p.y), p.color);
    drawPixel(p.x,p.y,p.color);
  });
}

// --- Real-time updates ---
supabase.channel("public:pixels")
  .on("postgres_changes",{ event:"INSERT", schema:"public", table:"pixels" }, payload=>{
    const p = payload.new;
    const k = key(p.x,p.y);
    if(!pixels.has(k)){
      pixels.set(k,p.color);
      drawPixel(p.x,p.y,p.color);
    }
  })
  .subscribe();

// --- Place a pixel ---
async function placePixel(x,y,color){
  const k = key(x,y);
  if(pixels.has(k)) return; // cannot overwrite
  if(remaining<=0){ alert("No pixels left! Wait for refill."); return; }
  remaining--;
  pixels.set(k,color);
  drawPixel(x,y,color);
  updateInfo();
  await supabase.from("pixels").insert({x,y,color});
}

// --- Handle clicks ---
canvas.addEventListener("click", e=>{
  const rect = canvas.getBoundingClientRect();
  const x = Math.floor((e.clientX - rect.left)/pixelSize);
  const y = Math.floor((e.clientY - rect.top)/pixelSize);
  placePixel(x,y,colorInput.value);
});

// --- Refill tokens every 1 min ---
setInterval(()=>{ if(remaining<10){ remaining++; updateInfo(); } }, 60000);

// --- Midnight Israel reset + countdown ---
function getNextIsraelMidnight() {
  const now = new Date();
  const israelOffset = 3 * 60; // UTC+3
  const utcNow = now.getTime() + now.getTimezoneOffset()*60000;
  const israelNow = new Date(utcNow + israelOffset*60000);
  const nextMidnight = new Date(israelNow);
  nextMidnight.setHours(24,0,0,0);
  return new Date(nextMidnight.getTime() - israelOffset*60000); // convert back to UTC for timer
}

async function resetCanvas() {
  await supabase.from("pixels").delete().neq("id",0);
  clearCanvas();
  updateInfo();
  loadPixels();
}

function updateCountdown() {
  const now = new Date();
  const diff = nextResetTime - now;
  if(diff <= 0){
    resetCanvas();
    nextResetTime = getNextIsraelMidnight();
  }
  const totalSec = Math.floor(diff/1000);
  const h = String(Math.floor(totalSec/3600)).padStart(2,'0');
  const m = String(Math.floor((totalSec%3600)/60)).padStart(2,'0');
  const s = String(totalSec%60).padStart(2,'0');
  countdownEl.innerText = `Next reset in: ${h}:${m}:${s}`;
}

let nextResetTime = getNextIsraelMidnight();
setInterval(updateCountdown, 1000);

// --- Init ---
loadPixels();
updateInfo();
updateCountdown();

</script>
</head>
<body>
<h1>Persistent Shared Pixel Canvas</h1>
<div id="controls">
  <input type="color" id="color" value="#ff0000">
</div>
<canvas id="canvas"></canvas>
<div id="info"></div>
</body>
</html>
