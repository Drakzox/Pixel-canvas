<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Persistent Shared Pixel Canvas</title>
<style>
  body { display: flex; flex-direction: column; align-items: center; font-family: sans-serif; margin: 0; padding: 20px; background: #eee; }
  canvas { border: 1px solid #000; image-rendering: pixelated; cursor: crosshair; }
  #controls { margin-bottom: 10px; }
  #info { font-weight: bold; margin-top: 10px; }
</style>
<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// === Supabase config ===
const SUPABASE_URL = "https://pemfxpowmsajsxsveoli.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlbWZ4cG93bXNhanN4c3Zlb2xpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NjYyNzMsImV4cCI6MjA3MTM0MjI3M30.SJBgs4kQTqyn6S6A3usxTHaWK-nb2R51DMznT6geA_M";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// === Grid config ===
const gridWidth = 100;
const gridHeight = 60;
const pixelSize = 10;

// === Canvas setup ===
const canvas = document.getElementById("canvas");
canvas.width = gridWidth * pixelSize;
canvas.height = gridHeight * pixelSize;
const ctx = canvas.getContext("2d");

// === UI elements ===
const colorInput = document.getElementById("color");
const info = document.getElementById("info");

// === Pixel state ===
const pixels = new Map(); // key = x_y, value = color
let remaining = 10;

// --- Helpers ---
function key(x,y){ return `${x}_${y}`; }
function drawPixel(x,y,color){ ctx.fillStyle = color; ctx.fillRect(x*pixelSize,y*pixelSize,pixelSize,pixelSize); }
function updateInfo(){ info.innerText = `Pixels left: ${remaining}`; }

// --- Load existing pixels ---
async function loadPixels(){
  const { data } = await supabase.from("pixels").select("*");
  if(data) data.forEach(p => {
    pixels.set(key(p.x,p.y), p.color);
    drawPixel(p.x,p.y,p.color);
  });
}

// --- Real-time updates ---
supabase.channel("public:pixels")
  .on("postgres_changes",{ event:"INSERT", schema:"public", table:"pixels" }, payload=>{
    const p = payload.new;
    const k = key(p.x,p.y);
    if(!pixels.has(k)){
      pixels.set(k,p.color);
      drawPixel(p.x,p.y,p.color);
    }
  })
  .subscribe();

// --- Place a pixel ---
async function placePixel(x,y,color){
  const k = key(x,y);
  if(pixels.has(k)) return; // cannot overwrite
  if(remaining<=0){ alert("No pixels left! Wait for refill."); return; }
  remaining--;
  pixels.set(k,color);
  drawPixel(x,y,color);
  updateInfo();
  await supabase.from("pixels").insert({x,y,color});
}

// --- Handle clicks ---
canvas.addEventListener("click", e=>{
  const rect = canvas.getBoundingClientRect();
  const x = Math.floor((e.clientX - rect.left)/pixelSize);
  const y = Math.floor((e.clientY - rect.top)/pixelSize);
  placePixel(x,y,colorInput.value);
});

// --- Refill tokens every 1 min ---
setInterval(()=>{ if(remaining<10){ remaining++; updateInfo(); } }, 60000);

// --- Init ---
loadPixels();
updateInfo();
</script>
</head>
<body>
<h1>Persistent Shared Pixel Canvas</h1>
<div id="controls">
  <input type="color" id="color" value="#ff0000">
</div>
<canvas id="canvas"></canvas>
<div id="info"></div>
</body>
</html>
